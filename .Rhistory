Sales_a = S_0,  # Fixed sales
Sales_b_rho_1 = returns_to_price_R(S_0, sales_returns$R_Sales_b_rho_1),
Sales_b_rho_2 = returns_to_price_R(S_0, sales_returns$R_Sales_b_rho_2)
)
final_data <- copper_data2 %>%
left_join(sales, by = "Date")
OC_ratio <- 0.06
OC_0 <- OC_ratio * S_0
DL_ratio <- 0.14
DL_0 <- DL_ratio * S_0
OH <- 77000000
EBIT_0 <- S_0 - material_cost_0 - OC_0 - DL_0 - OH
final_data2 <- final_data %>%
mutate(
EBIT_a = Sales_a - Material_cost_t - 0.06*Sales_a - 0.14*Sales_a - OH,
EBIT_b_rho_1 = Sales_b_rho_1 - Material_cost_t - 0.06 * Sales_b_rho_1 - 0.14 * Sales_b_rho_1 - OH,
EBIT_b_rho_2 = Sales_b_rho_2 - Material_cost_t - 0.06 * Sales_b_rho_2 - 0.14 * Sales_b_rho_2 - OH
)
EBIT <- final_data2 %>%
summarise(
EBIT_a = mean(EBIT_a, na.rm = TRUE),
EBIT_b_rho_1 = mean(EBIT_b_rho_1, na.rm = TRUE),
EBIT_b_rho_2 = mean(EBIT_b_rho_2, na.rm = TRUE)
)
EBIT_a_last <- tail(final_data2$EBIT_a, 1)  # should equal EBIT_0 (≈24.2m)
EBIT_b_rho_1_last <- tail(final_data2$EBIT_b_rho_1, 1)
EBIT_b_rho_2_last <- tail(final_data2$EBIT_b_rho_2, 1)
print(paste(EBIT))
alpha <- 0.05
# Zakaj tako: “slab rep” za EBIT je spodaj, “slab rep” za loss je zgoraj.
#-------------------------------------------
ebit_var_etl <- function(ebit_vec, alpha = 0.05) {
ebit_vec <- ebit_vec[!is.na(ebit_vec)]
EBIT_VaR <- as.numeric(quantile(ebit_vec, probs = alpha))
EBIT_ETL <- mean(ebit_vec[ebit_vec <= EBIT_VaR], na.rm = TRUE)
tibble(
alpha = alpha,
EBIT_VaR = EBIT_VaR,
EBIT_ETL = EBIT_ETL
)
}
risk_table <- bind_rows(
ebit_var_etl(final_data2$EBIT_a, alpha)       %>% mutate(case = "a) fixed sales"),
ebit_var_etl(final_data2$EBIT_b_rho_1, alpha) %>% mutate(case = "b) rho = 0.74"),
ebit_var_etl(final_data2$EBIT_b_rho_2, alpha) %>% mutate(case = "b) rho = 0.92")
) %>% select(case, alpha, EBIT_VaR, EBIT_ETL)
risk_table_m <- risk_table %>%
mutate(across(c(EBIT_VaR, EBIT_ETL), ~ .x/1e6))
library(readr)
library(dplyr)
library(lubridate)
library(tibble)
# Assumptions / units:
# - copper.csv spot prices look like USD per metric ton (values ~ 8,000–10,000)
# - copper_futures.csv (HG=F) is typically USD per pound
#   => convert futures to USD per metric ton via lb_per_ton
lb_per_ton = 2204.62262185
contract_size_lb  = 25000 # 25k pounds of copper per contract
contract_size_ton = contract_size_lb / lb_per_ton # the same contract but expressed in metric tons bc thats the metric in copper.csv
futures = read_csv(
"copper_futures.csv",
skip = 3,
col_names = c("Date","Close","High","Low","Open","Volume"),
show_col_types = FALSE
) %>%
mutate(
Date = as.Date(Date),
Close = as.numeric(Close),
Fut_USD_per_ton = Close * lb_per_ton
) %>%
select(Date, Fut_USD_per_ton)
if (!exists("final_data2")) stop("final_data2 not found. Run source('ziva.r') first (and ensure it finishes without errors).")
if (is.character(final_data2$Date)) {
final_data2 = final_data2 %>% mutate(Date = dmy(Date))
} else if (!inherits(final_data2$Date, "Date")) {
final_data2 = final_data2 %>% mutate(Date = as.Date(Date))
}
# 2) Join futures onto your scenario table
df_hedge = final_data2 %>%
inner_join(futures, by = "Date") %>%
arrange(Date)
# 3) Compute changes for hedge ratio estimation
# Material_cost_t is already in USD (Price_USD * k_factor)
df_hedge = df_hedge %>%
mutate(
dCM = Material_cost_t - lag(Material_cost_t),     # USD change in material costs
dF  = Fut_USD_per_ton - lag(Fut_USD_per_ton)      # USD/ton change in futures price
) %>%
filter(!is.na(dCM), !is.na(dF))
# 4) Optimal hedge ratio (minimum-variance hedge)
# h* = Cov(dCM, dF) / Var(dF)
h_star_ton = cov(df_hedge$dCM, df_hedge$dF) / var(df_hedge$dF)
# number of futures contracts (rough implementation size)
N_contracts = h_star_ton / contract_size_ton
cat("\n--- Hedge ratio using actual copper futures ---\n")
cat("Optimal hedge quantity h* (metric tons):", round(h_star_ton, 2), "\n")
cat("Contract size (metric tons):", round(contract_size_ton, 4), "\n")
cat("Approx. number of contracts:", round(N_contracts, 0), "\n")
# 5) Apply hedge P&L to EBIT
# Company is effectively LONG copper (it must buy it). To hedge rising prices:
# take a LONG futures position -> P&L_t = h* * dF_t  (positive when futures rise)
df_hedge = df_hedge %>%
mutate(
hedgePnL = h_star_ton * dF,
EBIT_a_hedged         = EBIT_a         + hedgePnL,
EBIT_b_rho_1_hedged   = EBIT_b_rho_1   + hedgePnL,
EBIT_b_rho_2_hedged   = EBIT_b_rho_2   + hedgePnL
)
ebit_var_etl = function(ebit_vec, alpha = 0.05) {
ebit_vec = ebit_vec[!is.na(ebit_vec)]
EBIT_VaR = as.numeric(quantile(ebit_vec, probs = alpha))
EBIT_ETL = mean(ebit_vec[ebit_vec <= EBIT_VaR], na.rm = TRUE)
tibble(alpha = alpha, EBIT_VaR = EBIT_VaR, EBIT_ETL = EBIT_ETL)
}
alpha = 0.05
risk_unhedged = bind_rows(
ebit_var_etl(df_hedge$EBIT_a, alpha)       %>% mutate(case = "a) fixed sales",        strategy = "unhedged"),
ebit_var_etl(df_hedge$EBIT_b_rho_1, alpha) %>% mutate(case = "b) rho = 0.74",         strategy = "unhedged"),
ebit_var_etl(df_hedge$EBIT_b_rho_2, alpha) %>% mutate(case = "b) rho = 0.92",         strategy = "unhedged")
)
risk_hedged_fut = bind_rows(
ebit_var_etl(df_hedge$EBIT_a_hedged, alpha)       %>% mutate(case = "a) fixed sales", strategy = "hedged (copper futures)"),
ebit_var_etl(df_hedge$EBIT_b_rho_1_hedged, alpha) %>% mutate(case = "b) rho = 0.74",  strategy = "hedged (copper futures)"),
ebit_var_etl(df_hedge$EBIT_b_rho_2_hedged, alpha) %>% mutate(case = "b) rho = 0.92",  strategy = "hedged (copper futures)")
)
risk_part5_futures = bind_rows(risk_unhedged, risk_hedged_fut) %>%
mutate(across(c(EBIT_VaR, EBIT_ETL), ~ .x/1e6)) %>%  # show in USD millions
select(case, strategy, alpha, EBIT_VaR, EBIT_ETL)
cat("\n--- VaR/ETL comparison (USD millions) ---\n")
print(risk_part5_futures)
# Create a synthetic derivative price series with corr ~ 0.75 to dCM
# then compute hedge ratio again and re-run VaR/ETL.
set.seed(42)
rho_deriv = 0.75
# epsilon with same sd as dCM so the constructed series has theoretical corr rho
eps = rnorm(nrow(df_hedge), mean = 0, sd = sd(df_hedge$dCM))
dD = rho_deriv * df_hedge$dCM + sqrt(1 - rho_deriv^2) * eps
# Build a "derivative price" path (level doesn't matter for hedge ratio, but we create it anyway)
D0 = first(df_hedge$Fut_USD_per_ton)  # anchor at futures level (USD/ton)
D_price = D0 + cumsum(dD / h_star_ton)  # scale so changes are roughly comparable in USD/ton
df_hedge = df_hedge %>%
mutate(
Deriv_USD_per_ton = D_price,
dDeriv = Deriv_USD_per_ton - lag(Deriv_USD_per_ton)
) %>%
filter(!is.na(dDeriv))
# Optimal hedge ratio vs synthetic derivative
h_star_deriv_ton = cov(df_hedge$dCM, df_hedge$dDeriv) / var(df_hedge$dDeriv)
N_contracts_deriv = h_star_deriv_ton / contract_size_ton
cat("\n--- Hedge ratio using synthetic derivative (corr ~ 0.75 to dCM) ---\n")
cat("Sample corr(dCM, dDeriv):", round(cor(df_hedge$dCM, df_hedge$dDeriv), 3), "\n")
cat("Optimal hedge quantity h* (metric tons):", round(h_star_deriv_ton, 2), "\n")
cat("Approx. number of contracts:", round(N_contracts_deriv, 0), "\n")
df_hedge = df_hedge %>%
mutate(
hedgePnL_deriv = h_star_deriv_ton * dDeriv,
EBIT_a_hedged_deriv       = EBIT_a       + hedgePnL_deriv,
EBIT_b_rho_1_hedged_deriv = EBIT_b_rho_1 + hedgePnL_deriv,
EBIT_b_rho_2_hedged_deriv = EBIT_b_rho_2 + hedgePnL_deriv
)
risk_hedged_deriv = bind_rows(
ebit_var_etl(df_hedge$EBIT_a_hedged_deriv, alpha)       %>% mutate(case = "a) fixed sales", strategy = "hedged (deriv corr~0.75)"),
ebit_var_etl(df_hedge$EBIT_b_rho_1_hedged_deriv, alpha) %>% mutate(case = "b) rho = 0.74",  strategy = "hedged (deriv corr~0.75)"),
ebit_var_etl(df_hedge$EBIT_b_rho_2_hedged_deriv, alpha) %>% mutate(case = "b) rho = 0.92",  strategy = "hedged (deriv corr~0.75)")
)
risk_part5_deriv = bind_rows(risk_unhedged, risk_hedged_deriv) %>%
mutate(across(c(EBIT_VaR, EBIT_ETL), ~ .x/1e6)) %>%
select(case, strategy, alpha, EBIT_VaR, EBIT_ETL)
cat("\n--- VaR/ETL comparison with synthetic derivative (USD millions) ---\n")
print(risk_part5_deriv)
rho_set = c(0.60, 0.75, 0.90)
# Safety checks
if (!exists("final_data2")) stop("final_data2 not found. Source ziva.r first.")
if (!exists("futures"))    stop("futures not found. Run Part 5 futures import first.")
if (!exists("ebit_var_etl")) stop("ebit_var_etl() not found. Keep the Part 5 function definition.")
# avoid shit from p5 filtering
df_base = final_data2 %>%
inner_join(futures, by = "Date") %>%
arrange(Date) %>%
mutate(
dCM = Material_cost_t - lag(Material_cost_t),   # USD change in material costs
dF  = Fut_USD_per_ton - lag(Fut_USD_per_ton)    # USD/ton change in futures (used only for scaling)
) %>%
filter(!is.na(dCM), !is.na(dF))
alpha = 0.05
# Unhedged risk
risk_unhedged_base = bind_rows(
ebit_var_etl(df_base$EBIT_a, alpha) %>%
mutate(case = "a) fixed sales", strategy = "unhedged"),
ebit_var_etl(df_base$EBIT_b_rho_1, alpha) %>%
mutate(case = "b) rho = 0.74",  strategy = "unhedged"),
ebit_var_etl(df_base$EBIT_b_rho_2, alpha) %>%
mutate(case = "b) rho = 0.92",  strategy = "unhedged")
) %>%
mutate(rho_deriv = NA_real_)
# Create synthetic derivative *changes* dDeriv with (approximately exact) sample corr = rho to dCM
# We standardize dCM, orthogonalize noise to dCM, then mix.
make_dDeriv = function(dCM, sd_target, rho, seed = 42) {
set.seed(seed + round(rho * 1000))
zCM = as.numeric(scale(dCM, center = TRUE, scale = TRUE))
eps = rnorm(length(zCM))
# Remove projection of eps on zCM => sample covariance ~ 0
eps_orth = eps - (sum(eps * zCM) / sum(zCM^2)) * zCM
eps_orth = eps_orth / sd(eps_orth)
zDer = rho * zCM + sqrt(1 - rho^2) * eps_orth
dDeriv = zDer * sd_target   # scale to USD/ton magnitude comparable to futures moves
return(dDeriv)
}
# We scale derivative changes to have volatility similar to futures (USD/ton), so hedge ratios are comparable across rho.
sd_target = sd(df_base$dF)
# Loop over rho values
risk_hedged_list = list()
eff_list = list()
for (rho in rho_set) {
dDeriv = make_dDeriv(df_base$dCM, sd_target, rho, seed = 42)
# Hedge ratio (tons): h* = Cov(dCM, dDeriv) / Var(dDeriv)
h_star_ton = cov(df_base$dCM, dDeriv) / var(dDeriv)
# Hedge effectiveness on material-cost changes:
# residual = dCM - h*dDeriv  (min-variance residual)
resid = df_base$dCM - h_star_ton * dDeriv
hedge_eff = 1 - var(resid) / var(df_base$dCM)
# Apply hedge P&L to EBIT
hedgePnL = h_star_ton * dDeriv
EBIT_a_h = df_base$EBIT_a + hedgePnL
EBIT_b_074_h = df_base$EBIT_b_rho_1 + hedgePnL
EBIT_b_092_h = df_base$EBIT_b_rho_2 + hedgePnL
risk_hedged = bind_rows(
ebit_var_etl(EBIT_a_h, alpha) %>%
mutate(case = "a) fixed sales"),
ebit_var_etl(EBIT_b_074_h, alpha) %>%
mutate(case = "b) rho = 0.74"),
ebit_var_etl(EBIT_b_092_h, alpha) %>%
mutate(case = "b) rho = 0.92")
) %>%
mutate(
strategy  = paste0("hedged (deriv corr~", rho, ")"),
rho_deriv = rho
)
risk_hedged_list[[as.character(rho)]] = risk_hedged
eff_list[[as.character(rho)]] = tibble(
rho_deriv = rho,
sample_corr = cor(df_base$dCM, dDeriv),
h_star_ton = h_star_ton,
hedge_effectiveness = hedge_eff
)
}
risk_part6 = bind_rows(risk_unhedged_base, bind_rows(risk_hedged_list)) %>%
mutate(across(c(EBIT_VaR, EBIT_ETL), ~ .x / 1e6)) %>%   # USD millions
select(case, strategy, rho_deriv, alpha, EBIT_VaR, EBIT_ETL)
eff_part6 = bind_rows(eff_list) %>%
mutate(
h_star_ton = as.numeric(h_star_ton),
hedge_effectiveness = as.numeric(hedge_effectiveness)
)
cat("\n--- PART 6: VaR/ETL vs derivative correlation (USD millions) ---\n")
print(risk_part6)
cat("\n--- PART 6: Hedge efficiency diagnostics (cost-change variance reduction) ---\n")
print(eff_part6)
library(readr)
library(dplyr)
library(tibble)
library(readxl)
# ---- Given constants (same as before except other materials ratio) ----
S_0 <- 920000000
OH  <- 77000000
DL_ratio <- 0.14
OM_ratio <- 0.05   # other variable materials NOW 5% (instead of 6%)
# Exposures at current prices
w1 <- 0.57
w2 <- 0.15
CM1_0 <- S_0 * w1
CM2_0 <- S_0 * w2
# ---- 9.1 Choose two commodities and load spot prices ----
# Replace with your real filenames and column names
c1 <- read_csv("copper.csv", show_col_types = FALSE) %>%
rename(Date = Month, Price_USD = Price)
c2 <- read_xls("aluminium.xls") %>%
rename(Date = Month, Price_USD = Price) %>% select(Date, Price_USD)
c2$Price_USD = parse_number(c2$Price_USD)
c1$Date <- as.Date(c1$Date, format = "%m/%d/%y")
c1$Date <- format(c1$Date, "%d.%m.%Y")
c2$Date <- as.Date(c2$Date, format = "%d/%m/%y")
c2$Date <- format(c2$Date, "%d.%m.%Y")
# Align dates
spot2 <- inner_join(c1, c2, by = "Date") %>%
arrange(Date) %>% rename(Price_USD_co = Price_USD.x, Price_USD_al = Price_USD.y, )
# Current (last) prices
P_co_0 <- tail(spot2$Price_USD_co, 1)
P_al_0 <- tail(spot2$Price_USD_al, 1)
# Effective quantities (k-factors) so that at current price the cost matches 57% and 15% of sales
k1 <- CM1_0 / P_co_0
k2 <- CM2_0 / P_al_0
# Build time series of costs
spot2 <- spot2 %>%
mutate(
CM1_t = k1 * Price_USD_co,
CM2_t = k2 * Price_USD_al,
CM_t  = CM1_t + CM2_t,                 # total core material cost
CM_logret = c(NA, diff(log(CM_t)))     # returns for risk & sales simulation
)
# ---- 9.2 Sales time series: a) fixed, b) correlated with CM returns ----
rho_sales_1 <- 0.74
rho_sales_2 <- 0.92
df9 <- spot2 %>%
filter(!is.na(CM_logret)) %>%
select(Date, Price_USD_co, Price_USD_al, CM1_t, CM2_t, CM_t, CM_logret)
N <- nrow(df9)
set.seed(42)
eps <- rnorm(N, 0, 1)
calc_corr_returns <- function(base_ret, eps, rho) {
# base_ret should be standardized if you want more exact control;
# for your previous style, we keep it simple:
rho * base_ret + sqrt(1 - rho^2) * eps * sd(base_ret)
}
# If you want tighter correlation control, standardize base_ret:
base_ret <- df9$CM_logret
base_z   <- as.numeric(scale(base_ret))
R_sales_b1_z <- rho_sales_1 * base_z + sqrt(1 - rho_sales_1^2) * eps
R_sales_b2_z <- rho_sales_2 * base_z + sqrt(1 - rho_sales_2^2) * eps
# Scale back to similar vol as base returns
R_sales_b1 <- R_sales_b1_z * sd(base_ret)
R_sales_b2 <- R_sales_b2_z * sd(base_ret)
returns_to_level <- function(S0, r) {
out <- numeric(length(r))
prev <- S0
for (i in seq_along(r)) {
prev <- prev * exp(r[i])
out[i] <- prev
}
out
}
df9 <- df9 %>%
mutate(
Sales_a = S_0,
Sales_b_r074 = returns_to_level(S_0, R_sales_b1),
Sales_b_r092 = returns_to_level(S_0, R_sales_b2)
)
# ---- 9.3 EBIT simulation (no financial part) ----
EBIT_0 <- S_0 - (CM1_0 + CM2_0) - OM_ratio*S_0 - DL_ratio*S_0 - OH
df9 <- df9 %>%
mutate(
EBIT_a      = Sales_a      - CM_t - OM_ratio*Sales_a      - DL_ratio*Sales_a      - OH,
EBIT_b_r074 = Sales_b_r074 - CM_t - OM_ratio*Sales_b_r074 - DL_ratio*Sales_b_r074 - OH,
EBIT_b_r092 = Sales_b_r092 - CM_t - OM_ratio*Sales_b_r092 - DL_ratio*Sales_b_r092 - OH
)
# ---- 9.4 VaR & ETL for EBIT (same function as before) ----
alpha <- 0.05
ebit_var_etl <- function(ebit_vec, alpha = 0.05) {
ebit_vec <- ebit_vec[!is.na(ebit_vec)]
VaR <- as.numeric(quantile(ebit_vec, probs = alpha))
ETL <- mean(ebit_vec[ebit_vec <= VaR], na.rm = TRUE)
tibble(alpha = alpha, EBIT_VaR = VaR, EBIT_ETL = ETL)
}
risk_unhedged_9 <- bind_rows(
ebit_var_etl(df9$EBIT_a, alpha)      %>% mutate(case = "a) fixed sales"),
ebit_var_etl(df9$EBIT_b_r074, alpha) %>% mutate(case = "b) sales corr 0.74"),
ebit_var_etl(df9$EBIT_b_r092, alpha) %>% mutate(case = "b) sales corr 0.92")
) %>%
mutate(across(c(EBIT_VaR, EBIT_ETL), ~ .x/1e6))
print(paste("Point estimate EBIT_0 (USD):", format(EBIT_0)))
print(risk_unhedged_9)
#---- 9.5 Hedging with TWO futures (minimum variance hedge vector) ----
lb_per_ton = 2204.62262185
futures1 = read_csv(
"copper_futures.csv",
skip = 3,
col_names = c("Date","Close","High","Low","Open","Volume"),
show_col_types = FALSE
) %>%
mutate(
Date = as.Date(Date),
Close = as.numeric(Close),
Fut_USD_per_ton_co = Close * lb_per_ton
) %>%
select(Date, Fut_USD_per_ton_co)
futures2 = read_csv(
"aluminium_futures.csv",
skip = 3,
col_names = c("Date","Close","High","Low","Open","Volume"),
show_col_types = FALSE
) %>%
mutate(
Date = as.Date(Date),
Close = as.numeric(Close),
Fut_USD_per_ton_al = Close * lb_per_ton
) %>%
select(Date, Fut_USD_per_ton_al) %>% filter(format(Date, "%d") == "01")
futures1$Date <- as.Date(futures1$Date)
futures2$Date <- as.Date(futures2$Date)
df9 = df9 %>%
mutate(Date = as.Date(Date, format = "%d.%m.%Y"))
dfH <- df9 %>%
inner_join(futures1, by = "Date") %>%
inner_join(futures2, by = "Date") %>%
arrange(Date) %>%
mutate(
dCM = CM_t - lag(CM_t),
dF_Cu = Fut_USD_per_ton_co   - lag(Fut_USD_per_ton_co),
dF_Al = Fut_USD_per_ton_al   - lag(Fut_USD_per_ton_al)
) %>%
filter(!is.na(dCM), !is.na(dF_Cu), !is.na(dF_Al))
# Variance-covariance matrix of futures
Sigma_F <- var(cbind(dfH$dF_Cu, dfH$dF_Al))
# Covariance with material cost changes
Sigma_F_CM <- cov(cbind(dfH$dF_Cu, dfH$dF_Al), dfH$dCM)[,1]
# Minimum-variance hedge ratios
h_star <- solve(Sigma_F, Sigma_F_CM)
names(h_star) <- c("h_Copper", "h_Aluminium")
print(h_star)
dfH <- dfH %>%
mutate(
hedgePnL <- h_star[1]*dfH$dF_Cu + h_star[2]*dfH$dF_Al,
EBIT_a_h      = EBIT_a      + HedgePnL,
EBIT_b_r074_h = EBIT_b_r074 + HedgePnL,
EBIT_b_r092_h = EBIT_b_r092 + HedgePnL
)
# print(h_star)
print(risk_hedged_9)
make_deriv <- function(dCM, sd_target, rho, seed = 42) {
set.seed(seed + round(1000*rho))
zCM <- as.numeric(scale(dCM))
eps <- rnorm(length(zCM))
eps <- eps - (sum(eps*zCM)/sum(zCM^2))*zCM
zDer <- rho*zCM + sqrt(1-rho^2)*eps
zDer * sd_target
}
rho_set <- c(0.60, 0.75, 0.90)
# Apply hedge P&L to EBIT
hedgePnL = h_star_ton * dDeriv
dfH <- dfH %>%
mutate(
hedgePnL <- h_star[1]*dfH$dF_Cu + h_star[2]*dfH$dF_Al,
EBIT_a_h      = EBIT_a      + HedgePnL,
EBIT_b_r074_h = EBIT_b_r074 + HedgePnL,
EBIT_b_r092_h = EBIT_b_r092 + HedgePnL
)
dfH <- dfH %>%
mutate(
hedgePnL <- h_star[1]*dfH$dF_Cu + h_star[2]*dfH$dF_Al,
EBIT_a_h      = EBIT_a      + HedgePnL,
EBIT_b_r074_h = EBIT_b_r074 + HedgePnL,
EBIT_b_r092_h = EBIT_b_r092 + HedgePnL
)
HedgePnL <- h_star[1]*dfH$dF_Cu + h_star[2]*dfH$dF_Al
dfH <- dfH %>%
mutate(
hedgePnL <- h_star[1]*dfH$dF_Cu + h_star[2]*dfH$dF_Al,
EBIT_a_h      = EBIT_a      + HedgePnL,
EBIT_b_r074_h = EBIT_b_r074 + HedgePnL,
EBIT_b_r092_h = EBIT_b_r092 + HedgePnL
)
dfH <- dfH %>%
mutate(
HedgePnL <- h_star[1]*dfH$dF_Cu + h_star[2]*dfH$dF_Al,
EBIT_a_h      = EBIT_a      + HedgePnL,
EBIT_b_r074_h = EBIT_b_r074 + HedgePnL,
EBIT_b_r092_h = EBIT_b_r092 + HedgePnL
)
risk_hedged_9 <- bind_rows(
ebit_var_etl(dfH$EBIT_a_h, alpha)      %>% mutate(case = "a) fixed sales"),
ebit_var_etl(dfH$EBIT_b_r074_h, alpha) %>% mutate(case = "b) sales corr 0.74"),
ebit_var_etl(dfH$EBIT_b_r092_h, alpha) %>% mutate(case = "b) sales corr 0.92")
) %>%
mutate(strategy = "hedged (2-futures)",
h1 = h_star[1], h2 = h_star[2]) %>%
mutate(across(c(EBIT_VaR, EBIT_ETL), ~ .x/1e6))
# print(h_star)
print(risk_hedged_9)
make_deriv <- function(dCM, sd_target, rho, seed = 42) {
set.seed(seed + round(1000*rho))
zCM <- as.numeric(scale(dCM))
eps <- rnorm(length(zCM))
eps <- eps - (sum(eps*zCM)/sum(zCM^2))*zCM
zDer <- rho*zCM + sqrt(1-rho^2)*eps
zDer * sd_target
}
rho_set <- c(0.60, 0.75, 0.90)
results_9_6 <- list()
for (rho in rho_set) {
dF1 <- make_deriv(dfH$dCM, sd(dfH$dF_Cu), rho)
dF2 <- make_deriv(dfH$dCM, sd(dfH$dF_Al), rho+0.01)
Sigma_F <- var(cbind(dF1, dF2))
Sigma_F_CM <- cov(cbind(dF1, dF2), dfH$dCM)[,1]
h_star <- solve(Sigma_F, Sigma_F_CM)
HedgePnL <- h_star[1]*dF1 + h_star[2]*dF2
EBIT_h <- dfH$EBIT_a + HedgePnL
results_9_6[[as.character(rho)]] <-
ebit_var_etl(EBIT_h, alpha) %>%
mutate(rho_deriv = rho)
}
risk_9_6 <- bind_rows(results_9_6) %>%
mutate(across(c(EBIT_VaR, EBIT_ETL), ~ .x/1e6))
print(risk_9_6)
cor(copper$Price_USD, aluminium$Price_USD, use = "complete.obs")
View(copper_data)
View(c1)
View(c2)
cor(diff(CM_copper), diff(CM_aluminium), use = "complete.obs")
cor(c1$Price_USD, c2$Price_USD, use = "complete.obs")
cor(
diff(df9$CM1_t),
diff(df9$CM2_t),
use = "complete.obs"
)
paste(
"Sample period:",
format(min(df9$Date)),
"-",
format(max(df9$Date))
)
risk_unhedged_9 %>%
mutate(case = paste(case, "(two-commodity)"))
